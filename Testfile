import * as chunkUtils from "src/utils/common/file-download";
import * as shaUtils from "src/utils/common/file-download";

// Mock sha1Base64
jest.spyOn(shaUtils, "sha1Base64").mockResolvedValue("FAKE_HASH==");

it("should redirect back to regulatory page on save changes", async () => {
  jest.spyOn(chunkUtils, "createChunks")
    .mockResolvedValue([ new Blob(["abc"]), new Blob(["def"]) ]);

  const mockFile = new File(["hello world"], "test.csv");

  const mockNewFile = {
    file: mockFile,
    fileName: "test.csv",
    fileType: "csv",
    fileUuid: "abc",
    fileSize: mockFile.size, // IMPORTANT: must match real size
  };

  // mock context
  (FileDataContext.useFileData as jest.Mock).mockReturnValue({
    setCurrentFile: jest.fn(),
    fileDataList: [mockNewFile],
    currentFile: mockNewFile,
  });

  render(<FileSetting />);

  // Trigger upload
  fireEvent.click(screen.getByText("Upload"));

  // Assertions
  expect(chunkUtils.createChunks).toHaveBeenCalled();
  expect(shaUtils.sha1Base64).toHaveBeenCalledTimes(2);
});
